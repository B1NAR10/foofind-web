{% extends "files/base.html" %}
{%- macro searched(param,value="",more_values=[],parent="") %}
    {%- if param in args %}
        {% set params=args[param] %}
    {%- else -%}
        {% set params=[] %}
    {% endif -%}
    {%- if (value=="" and param not in args) or value in args[param] or (parent!="" and parent in params) %} class="active"
    {%- else -%}
        {% set active=false -%}
        {% for more in more_values if not active and param in args and more in params -%}
            {% set active=true %} class="active"
        {%- endfor -%}
    {% endif -%}
{% endmacro -%}
{% macro checkbox(value,parent,text="") -%}
    <li title="{{_(g.sources_names[value])}}"{{ searched('src',value,parent=parent) }}>
        <a href="{{url_search(src=value)}}" data-filter="{{ value }}">{%- if text %}{{ text }}{%- else -%}{{ value }}{% endif -%}</a>
    </li>
{%- endmacro %}
{% block head %}
    {%- assets "js_search" %}
        <script src="{{ ASSET_URL }}"></script>
    {%- endassets %}
    {%- if request.user_agent.platform=="iphone" or "ipad" in request.user_agent.string|lower() %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="{{ g.static_prefix }}/css/iphone_ipad.css" rel="stylesheet" type="text/css" />
    {% endif -%}
    {%- if alternate %}
        {% for alternate in alternate -%}
        <link rel="alternate" href="{{ alternate }}" />
        {% endfor -%}
    {% endif -%}
    {%- if canonical -%}
        <link rel="canonical" href="{{ canonical }}" />
    {% endif -%}
{% endblock %}
{% block content %}
    {% autoescape false %}
    <div id="fondo"></div>
    <div id="subcontent">
        <div id="flecha"></div>
        <div id="download"{% if static_download['html'] %} class="active">{{ static_download['html'] }}{% else %}>{% endif %}
        {% if not bot %}
            <div>
                <img alt="cargando" src="{{ g.static_prefix }}/img/search/cargando150.png" />
                <img alt="cargando" src="{{ g.static_prefix }}/img/search/cargando150.png" />
            </div>
        {% endif %}
        </div>
        {{ flash() }}
        <section>
            <aside>
                <dl>
                    <dt>{{_('what')|lower}}<a href="{{url_search(delete_params=['type'])}}" data-filter="type" title="{{_('all')}}">{{_('all')|lower}}</a></dt>
                    <dd id="type">
                        <ul>
                            <li{{ searched('type','audio') }}><a href="{{url_search(type='audio')}}" data-filter="audio" title="{{_('audio')}}: mp3, ogg, aac, wma, wav, amr, flac, oga...">{{_('audio')}}</a></li>
                            <li{{ searched('type','video') }}><a href="{{url_search(type='video')}}" data-filter="video" title="{{_('video')}}: avi, flv, mkv, mp4, wmv, mpg, mov, webm, 3gp, rmvb, vob...">{{_('video')}}</a></li>
                            <li{{ searched('type','image') }}><a href="{{url_search(type='image')}}" data-filter="image" title="{{_('image')}}: jpg, png, gif, bmp, tiff, psd, xcf...">{{_('image')}}</a></li>
                            <li{{ searched('type','document') }}><a href="{{url_search(type='document')}}" data-filter="document" title="{{_('document')}}: pdf, epub, doc, xls, ppt, odf, txt...">{{_('document')}}</a></li>
                            <li{{ searched('type','software') }}><a href="{{url_search(type='software')}}" data-filter="software" title="{{_('software')}}: exe, msi, apk, sys, iso, nrg...">{{_('software')}}</a></li>
                            <li><a></a></li>
                        </ul>
                    </dd>
                    <dt>{{_('where')|lower}}<a href="{{url_search(delete_params=['src'])}}" data-filter="src" title="{{_('all')}}">{{_('all')|lower}}</a></dt>
                    <dd id="src">
                        {% set params=args["src"] if "src" in args else [] %}
                        <ul>
                            <li{{ searched('src','streaming',g.sources_streaming) }}>
                                <a href="{{url_search(src='streaming')}}" data-filter="streaming" title="Streaming">Streaming</a>
                                <ul class="{% if not params %}inactive{% elif 'other-streamings' in params %}inactive_{{ sources_count['streaming']-(g.sources_streaming|length-9) }}{% else %}inactive_{{ sources_count['streaming'] }}{% endif %}">
                                    {%- for source in g.sources_streaming[:8] %}{{ checkbox(source,"streaming") }}{% endfor %}
                                    {{ checkbox("other-streamings","streaming",_("others")+" ("+(g.sources_streaming|length-8)|string+")") }}
                                    <li><button>{{_("update")}}</button></li>
                                </ul>
                                <span class="more">+
                                {% if params %}
                                {{ sources_count['streaming']-2 }} {{_("sources")}}</span>
                                <strong><span>{{ sources_count["streaming"] }}</span> / {{ g.sources_streaming|length }}</strong>
                                {% else %}
                                {{ g.sources_streaming|length-2 }} {{_("sources")}}</span>
                                {% endif %}
                            </li>
                            <li{{ searched('src','download',g.sources_download) }}>
                                <a href="{{url_search(src='download')}}" data-filter="download" title="{{_('direct_downloads')}}">{{_('direct_downloads')}}</a>
                                <ul class="{% if not params %}inactive{% elif 'other-downloads' in params %}inactive_{{ sources_count['download']-(g.sources_download|length-9) }}{% else %}inactive_{{ sources_count['download'] }}{% endif %}">
                                    {% for source in g.sources_download[:8] %}{{ checkbox(source,"download") }}{% endfor %}
                                    {{ checkbox("other-downloads","download",_("others")+" ("+(g.sources_download|length-8)|string+")") }}
                                    <li><button>{{_("update")}}</button></li>
                                </ul>
                                <span class="more">+
                                {% if params %}
                                {{ sources_count['download']-2 }} {{_("sources")}}</span>
                                <strong><span>{{ sources_count["download"] }}</span> / {{ g.sources_download|length }}</strong>
                                {% else %}
                                {{ g.sources_download|length-2 }} {{_("sources")}}</span>
                                {% endif %}
                            </li>
                            <li{{ searched('src','p2p',g.sources_p2p) }}>
                                <a href="{{url_search(src='p2p')}}" data-filter="p2p" title="P2P">P2P</a>
                                <ul class="{% if not params %}inactive{% else %}inactive_{{ sources_count['p2p'] }}{% endif %}">
                                    {% for source in g.sources_p2p %}{{ checkbox(source,"p2p") }}{% endfor %}
                                    <li><button>actualizar</button></li>
                                </ul>
                                <span class="more"></span>
                                {% if params %}<strong><span>{{ sources_count["p2p"] }}</span> / 3</strong>{% endif %}
                            </li>
                        </ul>
                    </dd>
                    <dt>{{_('size')|lower}}<a href="{{url_search(delete_params=['size'])}}" data-filter="size" title="{{_('all')}}">{{_('all')|lower}}</a></dt>
                    <dd id="size">
                        <div></div>
                        <span>{{_('minimun')}}</span><span>{{_('maximun')}}</span>
                    </dd>
                </dl>
            </aside>
            {% if args|length>1 %}
            <div id="filters">
                <a href="{{ url_search(delete_params=['all']) }}" class="close"></a>
                <ul>
                    {%- for name,value in top_filters.iteritems() if value -%}
                    <li title="{% if name=='type' %}{{_('what')}}{% elif name=='src' %}{{_('where')}} {{ value|join(' - ') }}{% else %}{{_('size')}}{% endif %}">
                    {%- if name=="size" %}
                        {% if value[0]>0 and value[1]==50 %}
                            {{_(value[3])}} <em>{{(2**value[0])|numbersizeformat}}</em>
                        {% elif value[0]==0 and value[1]<50 %}
                            {{_(value[2])}} <em>{{(2**value[1])|numbersizeformat}}</em>
                        {% else %}
                            {{_(value[3])}} <em>{{(2**value[0])|numbersizeformat}}</em> / {{_(value[2])}} <em>{{(2**value[1])|numbersizeformat}}</em>
                        {% endif %}
                    {% elif name=="src" %}
                        {%- if value|length>4 %}
                            {{ value|top_filters_src }}
                        {%- elif value|length>2 %}
                            {% if ("type" in top_filters and top_filters["type"]|length>2) or ("size" in top_filters and top_filters["size"][4]) or ("type" in top_filters and "size" in top_filters) %}
                                {{ value|top_filters_src }}
                            {% else %}
                                {{ value|join(" - ") }}
                            {% endif -%}
                        {% else %}
                            {{ value|join(" - ") }}
                        {% endif -%}
                    {% else %}
                        {{ value|join(" - ") }}
                    {% endif -%}
                    </li>
                    {%- endfor -%}
                </ul>
            </div>
            {% endif %}
            <ul id="results">
            {% if not bot %}
                <li id="loading">
                    <img alt="loading" src="{{ g.static_prefix }}/img/search/cargando.png" />
                    <img alt="loading" src="{{ g.static_prefix }}/img/search/cargando.png" />
                </li>
            {% endif %}
            {% if static_results %}
                {% for result in static_results %}
                    {{ result }}
                {% endfor %}
            {% endif %}
            </ul>
            <a href="#" id="more"></a>
        </section>
    </div>
    {% endautoescape %}
{% endblock %}
